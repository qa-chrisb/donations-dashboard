---
import Sparkline from "./Sparkline.tsx";
import { fmtMajor } from "../lib/format";
import type { DonationFeed } from "../lib/donationFeed";
import { loadDonationFeed } from "../lib/donationFeed";

export interface Props {
  /** Path or URL to JSON feed. For GitHub Pages, use `${import.meta.env.BASE_URL}data/donations.json` */
  src?: string;
  /** Max recent donations to show */
  limit?: number;
  /** If your feed mixes currencies, force one (e.g., "GBP") */
  currencyHint?: string;
  /** Optional pre-loaded data to avoid duplicate fetches */
  feed?: DonationFeed;
}

const {
  src = `${import.meta.env.BASE_URL}data/donations.json`,
  limit = 5,
  currencyHint,
  feed: providedFeed,
} = Astro.props as Props;

const feed = providedFeed ?? (await loadDonationFeed({ src, currencyHint }));
const { rows, currencies, singleCurrency: singleCCY, totalMajor: total } = feed;

const recent = rows.slice(0, limit);
const sparkValues = rows
  .slice(0, 12)
  .map((row) => row.amountMajor)
  .reverse();

const directionTheme = (amount: number) =>
  amount < 0 ? "text-rose-300" : "text-emerald-300";
---

<div class="surface-card" role="region" aria-label="Donations dashboard">
  <div
    class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"
  >
    <div>
      <p class="text-sm uppercase tracking-wide text-stone-400">Live feed</p>
      <p class="text-2xl font-semibold text-white">
        {singleCCY ? fmtMajor(total ?? 0, singleCCY) : `${rows.length} entries`}
      </p>
      <p class="text-sm text-stone-400">
        {
          singleCCY
            ? "Captured in the primary currency"
            : `Currencies: ${currencies.join(" / ")}`
        }
      </p>
    </div>

    <div class="flex flex-col items-start gap-2 text-right sm:items-end">
      <p class="text-sm text-stone-400">Recent {recent.length}</p>
      <div class="rounded-2xl border border-white/10 px-4 py-2">
        <Sparkline client:idle values={sparkValues} width={180} height={48} />
      </div>
    </div>
  </div>

  <div class="mt-5 divide-y divide-white/5" aria-live="polite">
    {
      recent.length === 0 ? (
        <p class="py-4 text-sm text-stone-400">No donations yet.</p>
      ) : (
        recent.map((donation) => (
          <article class="flex items-center justify-between gap-4 py-4">
            <div class="min-w-0">
              <p class="truncate font-medium text-white">{donation.name}</p>
              <p class="text-sm text-stone-400">
                {new Date(donation.date).toLocaleString("en-GB", {
                  dateStyle: "medium",
                  timeStyle: "short",
                })}
              </p>
            </div>
            <p
              class:list={[
                "shrink-0 text-right text-lg font-semibold",
                directionTheme(donation.amountMajor),
              ]}
            >
              {fmtMajor(Math.abs(donation.amountMajor), donation.currency)}
              {donation.amountMajor < 0 && (
                <span class="ml-1 text-xs uppercase tracking-wide">
                  refunded
                </span>
              )}
            </p>
          </article>
        ))
      )
    }
  </div>
</div>
