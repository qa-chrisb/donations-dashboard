---
import Sparkline from "./Sparkline.tsx";

export interface Props {
  /** Path or URL to JSON feed. For GitHub Pages, use `${import.meta.env.BASE_URL}data/donations.json` */
  src?: string;
  /** Max recent donations to show */
  limit?: number;
  /** If your feed mixes currencies, force one (e.g., "GBP") */
  currencyHint?: string;
}

const {
  src = `${import.meta.env.BASE_URL}data/donations.json`,
  limit = 5,
  currencyHint
} = Astro.props as Props;

// Robust loader:
// - Absolute http(s) -> fetch
// - Local public file -> read via fs at build time
// - If anything fails -> donations = []
let donationsRaw: any[] = [];
try {
  if (/^https?:\/\//i.test(src)) {
    const res = await fetch(src);
    donationsRaw = await res.json();
  } else {
    // Treat as path under public/ or an absolute-from-base URL.
    // Normalize leading slash.
    const rel = src.replace(/^\//, "");
    const fileUrl = new URL(`../../public/${rel}`, import.meta.url);
    const fs = await import("node:fs/promises");
    const txt = await fs.readFile(fileUrl, "utf8");
    donationsRaw = JSON.parse(txt);
  }
} catch {
  donationsRaw = [];
}

// Map various shapes to a common row type.
type Row = { id: string; name: string; date: string; amountMajor: number; currency: string };

function toRow(d: any): Row | null {
  // Our pipeline schema:
  // { id, provider, occurred_at, amount_minor, currency, donor_alias, status, ... }
  if (d && d.occurred_at && typeof d.amount_minor === "number") {
    const currency = (currencyHint || d.currency || "GBP").toUpperCase();
    const amtMajor = (d.status === "REFUNDED" ? -Math.abs(d.amount_minor) : d.amount_minor) / 100;
    return {
      id: d.id ?? `${d.provider}:${d.occurred_at}`,
      name: d.donor_alias ?? "Anonymous",
      date: d.occurred_at,
      amountMajor: amtMajor,
      currency,
    };
  }
  // Simple feed shape:
  // { id, name, date, amount, currency? }
  if (d && d.date && (typeof d.amount === "number" || typeof d.amount === "string")) {
    const currency = (currencyHint || d.currency || "GBP").toUpperCase();
    return {
      id: d.id ?? d.date,
      name: d.name ?? "Anonymous",
      date: d.date,
      amountMajor: Number(d.amount),
      currency,
    };
  }
  return null;
}

const rows = donationsRaw.map(toRow).filter(Boolean) as Row[];
rows.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const fmt = (n: number, ccy: string) =>
  new Intl.NumberFormat(undefined, { style: "currency", currency: ccy }).format(n);

// If mixed currencies, weâ€™ll display "mixed". If single currency, we sum it.
const currencies = Array.from(new Set(rows.map(r => r.currency)));
const singleCCY = currencyHint || (currencies.length === 1 ? currencies[0] : null);
const total = singleCCY
  ? rows.reduce((s, r) => s + (r.currency === singleCCY ? r.amountMajor : 0), 0)
  : null;

const recent = rows.slice(0, limit);
const sparkValues = rows.slice(0, 12).reverse().map(r => r.amountMajor);
---

<div class="rounded-2xl border border-gray-200 bg-white p-4 shadow-sm dark:border-gray-800 dark:bg-gray-950" role="region" aria-label="Donations dashboard">
  <div class="flex items-start justify-between gap-4">
    <div>
      <div class="text-base font-semibold">Donations</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">
        {singleCCY ? "Total received" : "Totals (mixed currencies)"}
      </div>
      <div class="mt-1 text-2xl font-semibold">
        {singleCCY ? fmt(total!, singleCCY) : currencies.join(", ")}
      </div>
    </div>

    <div class="text-right">
      <div class="text-sm text-gray-500 dark:text-gray-400">Recent {recent.length}</div>
      <div class="mt-2">
        <Sparkline client:idle values={sparkValues} width={160} height={42} />
      </div>
    </div>
  </div>

  <div class="mt-4 divide-y divide-gray-100 dark:divide-gray-800" aria-live="polite">
    {recent.length === 0 ? (
      <div class="py-3 text-sm text-gray-500 dark:text-gray-400">No donations yet.</div>
    ) : (
      recent.map((d) => (
        <div class="flex items-center justify-between py-3" key={d.id}>
          <div class="min-w-0">
            <div class="truncate font-medium">{d.name}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">{new Date(d.date).toLocaleString()}</div>
          </div>
          <div class="shrink-0 text-right font-semibold">{fmt(d.amountMajor, d.currency)}</div>
        </div>
      ))
    )}
  </div>
</div>
